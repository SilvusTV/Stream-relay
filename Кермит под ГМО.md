# TODO — Rendre /stats entièrement dynamique

Objectif
- Remplacer les valeurs en dur dans `GET /stats` par des valeurs dynamiques calculées à partir des métriques collectées pendant l’exécution (SRT/RIST) et des stats exposées par les transports.
- Fournir un plan pas-à-pas pour implémenter la collecte, l’agrégation et l’exposition.

État actuel
- `src/web/routes.rs::stats_endpoint` renvoie `StatsResponse` avec:
  - `uptime` dynamique via `metrics.start_time`.
  - `bitrate` et `mbpsRecvRate` calculés comme moyennes sur l’uptime (bytes cumulés / secondes écoulées).
  - Champs encore à 0: `bytesRcvDrop`, `bytesRcvLoss`, `mbpsBandwidth`, `msRcvBuf`, `pktRcvDrop`, `pktRcvLoss`, `rtt`.
- Les compteurs globaux sont alimentés dans `src/relay/pipe.rs` via `Metrics::global()`:
  - `add_bytes_in/out`, `inc_pkt_in/out`, `inc_timeout`, `inc/dec_active_relays`.
- `src/structures/metrics.rs` expose un registre Prometheus et des atomiques globaux.

Décision de portée
- Portée globale (pour démarrer): agrégation de tous les relais en un snapshot unique `/stats`.
- Optionnel plus tard: stats par relai `/stats/<relay_id>` ou `data.relays[]` dans la réponse.

Plan d’implémentation
1) Étendre `Metrics` (src/structures/metrics.rs)
   - Ajouter des compteurs de pertes côté réception:
     - `bytes_rcv_loss_total: AtomicU64`
     - `bytes_rcv_drop_total: AtomicU64`
     - `pkt_rcv_loss_total: AtomicU64`
     - `pkt_rcv_drop_total: AtomicU64`
   - Ajouter des « dernières valeurs » observées (gauges):
     - `last_rtt_ms: AtomicU64`
     - `last_rcvbuf_ms: AtomicU64`
     - `last_bandwidth_mbps: AtomicU64` (stocker `mbps * 1000` si l’on veut garder 3 décimales)
   - Ajouter un snapshot pour calculer des rates récents à la demande (option simple):
     - `rate_snapshot: Mutex<RateSnapshot>` avec `{ last_t: Instant, last_in: u64, last_out: u64 }`.
   - Helpers à implémenter:
     - `fn update_transport_stats(&self, ts: &TransportStats)`
     - `fn compute_recent_rates(&self) -> RecentRates` (delta bytes / delta temps)

2) Définir le contrat de stats côté transports (src/relay/transport/...)
   - Créer une struct:
     ```rust
     pub struct TransportStats {
         pub rtt_ms: Option<u32>,
         pub rcv_buf_ms: Option<u32>,
         pub recv_loss_bytes: Option<u64>,
         pub recv_drop_bytes: Option<u64>,
         pub recv_loss_pkts: Option<u64>,
         pub recv_drop_pkts: Option<u64>,
         pub bandwidth_mbps: Option<f64>,
     }
     ```
   - Ajouter un trait léger (extension du transport):